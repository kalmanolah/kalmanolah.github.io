<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://kalmanolah.net/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://kalmanolah.net/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://kalmanolah.net/theme/css/font-awesome.min.css">
  <link href="http://kalmanolah.net/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Rants of a Troubled Consultant RSS">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
<meta name="author" content="Kalman Olah" />
<meta name="description" content="NOTE: This is a repost of an old article. I noticed that it was generating a bunch of 404s for some people, so I figured I'd dig it up. Described as "a script kiddie's worst nightmare", fail2ban is a tool that reads log files, tries to match lines ..." />
<meta name="keywords" content="PHP, Symfony2, Security, fail2ban">
<meta property="og:site_name" content="Rants of a Troubled Consultant"/>
<meta property="og:title" content="Getting fail2ban to work with Symfony2 the proper(?) way"/>
<meta property="og:description" content="NOTE: This is a repost of an old article. I noticed that it was generating a bunch of 404s for some people, so I figured I'd dig it up. Described as "a script kiddie's worst nightmare", fail2ban is a tool that reads log files, tries to match lines ..."/>
<meta property="og:locale" content="en_BE"/>
<meta property="og:url" content="http://kalmanolah.net/getting-fail2ban-to-work-with-symfony2-the-proper-way.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2014-06-21 17:24:25+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://kalmanolah.net/author/kalman-olah.html">
<meta property="article:section" content="Web development"/>
<meta property="article:tag" content="PHP"/>
<meta property="article:tag" content="Symfony2"/>
<meta property="article:tag" content="Security"/>
<meta property="article:tag" content="fail2ban"/>
<meta property="og:image" content="/assets/img/stock_photo_of_some_guy.png">  <title>Rants of a Troubled Consultant &ndash; Getting fail2ban to work with Symfony2 the proper(?) way</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://kalmanolah.net">
        <img src="/assets/img/stock_photo_of_some_guy.png" alt="Rants of a Troubled Consultant" title="Rants of a Troubled Consultant">
      </a>
      <h1><a href="http://kalmanolah.net">Rants of a Troubled Consultant</a></h1>
      <p>Textual output generated by Kalman Olah: a pretty cool tech person who likes automation, game development, hardware, privacy and lazing about.</p>
      <nav>
        <ul class="list">
          <li><a href="http://kalmanolah.net/pages/about.html#about">About</a></li>
          <li><a href="https://github.com/kalmanolah/kalmanolah.github.io/tree/source" target="_blank">Source</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-github" href="https://github.com/kalmanolah" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="https://linkedin.com/in/KalmanOlah" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/KalmanOlah" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-envelope-o" href="/assets/misc/pubkey.asc" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+KalmanOlah1" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-rss" href="/feeds/all.rss" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://kalmanolah.net">Home</a>
      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="http://kalmanolah.net/feeds/all.rss">RSS</a>
    </nav>

<article>
  <header>
    <h1 id="getting-fail2ban-to-work-with-symfony2-the-proper-way">Getting fail2ban to work with Symfony2 the proper(?) way</h1>
    <p>Posted on Sat 21 June 2014 in <a href="http://kalmanolah.net/category/web-development.html">Web development</a></p>
  </header>
  <div>
    <p><em>NOTE: This is a repost of an old article. I noticed that it was generating
a bunch of 404s for some people, so I figured I'd dig it up.</em></p>
<p>Described as "a script kiddie's worst nightmare", <a href="http://en.wikipedia.org/wiki/Fail2ban">fail2ban</a> is a tool that
reads log files, tries to match lines to predefined rules or filters, extracts
an IP address from those lines and "bans" the host that IP address belongs to,
in a certain way.</p>
<p>It is extremely customizable, can send email notifications and do even more cool
stuff. If you want to learn more about fail2ban, you can visit its homepage
<a href="http://www.fail2ban.org">here</a>.</p>
<p>This blog post will be focusing on making this wonderful tool work properly with
Symfony2, so you can automatically ban anyone trying to gain access to your
application in a harmful manner for a certain period.</p>
<h2>Creating the Authentication Failure Handler</h2>
<p>Fail2ban needs a host or IP address so it can ban any offenders. This makes a
lot of sense, since generally it'll be creating temporary iptables rules that
drop packets coming from the offending IP address on ports 80 and 443.</p>
<p>Symfony however does not log the offender's IP address when authentication
fails, so we'll have to add that functionality ourselves by extending the
Default Authentication Failure Handler.</p>
<p>The only functionality we'll add is the logging of IP addresses when
authentication fails, in order to be able to extra data from our logs (stored in
app/logs/) using fail2ban.</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="c1"># src/Your/ExampleBundle/EventHandler/AuthenticationFailureHandler.php</span>
<span class="k">namespace</span> <span class="nx">Your\ExampleBundle\EventHandler</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Exception\AuthenticationException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Http\Authentication\DefaultAuthenticationFailureHandler</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthenticationFailureHandler</span> <span class="k">extends</span> <span class="nx">DefaultAuthenticationFailureHandler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onAuthenticationFailure</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">AuthenticationException</span> <span class="nv">$exception</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span> <span class="o">&amp;&amp;</span> <span class="k">null</span> <span class="o">!==</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getClientIp</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">error</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;Authentication failure for IP: %s&#39;</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getClientIp</span><span class="p">()));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">onAuthenticationFailure</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$exception</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>As you can see, the only real functionality we've added is the logging. Now for
the matching service definition:</p>
<div class="highlight"><pre><span></span><span class="c1"># src/Your/ExampleBundle/Resources/config/services.yml</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">your.examplebundle.authenticationfailurehandler</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Your\ExampleBundle\EventHandler\AuthenticationFailureHandler</span>
        <span class="l l-Scalar l-Scalar-Plain">arguments</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;@http_kernel&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;@security.http_utils&quot;</span><span class="p p-Indicator">,</span> <span class="p p-Indicator">{},</span> <span class="s">&quot;@logger&quot;</span><span class="p p-Indicator">]</span>
        <span class="l l-Scalar l-Scalar-Plain">tags</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span> <span class="nv">name</span><span class="p p-Indicator">:</span> <span class="s">&#39;monolog.logger&#39;</span><span class="p p-Indicator">,</span> <span class="nv">channel</span><span class="p p-Indicator">:</span> <span class="s">&#39;security&#39;</span> <span class="p p-Indicator">}</span>
</pre></div>


<p>You'll also need to tell Symfony to use your handler by specifying a
failure_handler in your security.yml, like so:</p>
<div class="highlight"><pre><span></span><span class="c1"># app/config/security.yml</span>
    <span class="l l-Scalar l-Scalar-Plain">firewalls</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">main</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">pattern</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">^/</span>
            <span class="l l-Scalar l-Scalar-Plain">form_login</span><span class="p p-Indicator">:</span>
                <span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">fos_userbundle</span>
                <span class="l l-Scalar l-Scalar-Plain">csrf_provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">form.csrf_provider</span>
                <span class="l l-Scalar l-Scalar-Plain">failure_handler</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">your.examplebundle.authenticationfailurehandler</span>
            <span class="l l-Scalar l-Scalar-Plain">logout</span><span class="p p-Indicator">:</span>       <span class="l l-Scalar l-Scalar-Plain">true</span>
            <span class="l l-Scalar l-Scalar-Plain">anonymous</span><span class="p p-Indicator">:</span>    <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>


<p>Alright, that's it for the Symfony part. You should be seeing the IP address of
any offenders in your <code>app/logs/%kernel.environment%.log</code> file, like so:</p>
<div class="highlight"><pre><span></span><span class="k">[2013-11-03 23:24:55] security.INFO: Authentication request failed: Bad credentials [] []</span>
<span class="k">[2013-11-03 23:24:55] security.ERROR: Authentication failure for IP: 127.0.0.1 [] []</span>
</pre></div>


<p>Next up: the fail2ban filter!</p>
<h2>Creating a custom fail2ban filter for Symfony2</h2>
<p>To create a new filter for fail2ban, we'll create a file in
<code>/etc/fail2ban/filter.d/symfony.conf</code> with the following contents:</p>
<div class="highlight"><pre><span></span><span class="k">[Definition]</span>
<span class="na">failregex</span> <span class="o">=</span> <span class="s">Authentication\sfailure\sfor\sIP:\s&lt;HOST&gt;\s</span>
</pre></div>


<p>That was easy, right? We should create a jail in <code>/etc/fail2ban/jail.local</code>
which uses our new filter. The definition for this jail will depend on your
configuration, but a basic one could look like this:</p>
<div class="highlight"><pre><span></span><span class="k">[symfony]</span>
<span class="na">enabled</span>   <span class="o">=</span> <span class="s">true</span>
<span class="na">filter</span>    <span class="o">=</span> <span class="s">symfony</span>
<span class="na">logpath</span>   <span class="o">=</span> <span class="s">/var/www/my-project/app/logs/prod.log</span>
<span class="na">port</span>      <span class="o">=</span> <span class="s">http,https</span>
<span class="na">bantime</span>   <span class="o">=</span> <span class="s">600</span>
<span class="na">banaction</span> <span class="o">=</span> <span class="s">iptables-multiport</span>
<span class="na">maxretry</span>  <span class="o">=</span> <span class="s">3</span>
</pre></div>


<p>Now all that remains is to execute <code>service fail2ban reload</code> and to test your
new setup.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://kalmanolah.net/tag/php.html">PHP</a>
      <a href="http://kalmanolah.net/tag/symfony2.html">Symfony2</a>
      <a href="http://kalmanolah.net/tag/security.html">Security</a>
      <a href="http://kalmanolah.net/tag/fail2ban.html">fail2ban</a>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'kalmanolah';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
      <p>&copy; Kalman Olah 2015</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-38768307-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Getting fail2ban to work with Symfony2 the proper(?) way",
  "headline": "Getting fail2ban to work with Symfony2 the proper(?) way",
  "datePublished": "2014-06-21 17:24:25+02:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Kalman Olah",
    "url": "http://kalmanolah.net/author/kalman-olah.html"
  },
  "image": "/assets/img/stock_photo_of_some_guy.png",
  "url": "http://kalmanolah.net/getting-fail2ban-to-work-with-symfony2-the-proper-way.html",
  "description": "NOTE: This is a repost of an old article. I noticed that it was generating a bunch of 404s for some people, so I figured I'd dig it up. Described as "a script kiddie's worst nightmare", fail2ban is a tool that reads log files, tries to match lines ..."
}
</script></body>
</html>